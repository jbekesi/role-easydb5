- name: easydb directories under {{ easydb_basedir }}
  file:
    state: directory
    path: "{{ file_item.path }}"
    owner: "{{ file_item.owner | default('root') }}"
    group: "{{ file_item.group | default('root') }}"
    mode: "{{ file_item.mode | default(0755) }}"
  loop_control:
    loop_var: file_item
  with_items:
    - path: "{{ easydb_basedir }}"
    - path: "{{ easydb_volume_config }}"
    - path: "{{ easydb_eas_volume_assets }}"
      owner: www-data
      group: www-data
    - path: "{{ easydb_eas_volume_log }}"
    - path: "{{ easydb_eas_volume_tmp }}"
      mode: u=rwx,g=rwx,o=rwx,o+t
    - path: "{{ easydb_elasticsearch_volume_var }}"
      mode: u=rwx,g=rwx,o=rwx
    - path: "{{ easydb_pgsql_volume_backup }}"
    - path: "{{ easydb_pgsql_volume_etc }}"
    - path: "{{ easydb_pgsql_volume_lib }}"
    - path: "{{ easydb_pgsql_volume_log }}"
    - path: "{{ easydb_server_volume_nginx_log }}"
      mode: u=rwx,g=rwx,o=rwx
    - path: "{{ easydb_server_volume_var }}"
    - path: "{{ easydb_server_volume_hotfolder }}"

- name: installing maintain script
  template:
    src: srv/easydb/maintain
    dest: "{{ easydb_basedir }}/maintain"
    owner: root
    group: root
    mode: 0755

- name: central configuration file
  template:
    src: srv/easydb/config/easydb5-master.yml.j2
    dest: "{{ easydb_basedir }}/config/easydb5-master.yml"
    owner: root
    group: root
    mode: u=rw,g=r,o=r

- name: EAS configuration file
  template:
    src: srv/easydb/config/easydb_asset_server.conf.j2
    dest: "{{ easydb_basedir }}/config/easydb_asset_server.conf"
    owner: root
    group: root
    mode: u=rw,g=r,o=r

- name: logging in to docker registry
  docker_login:
    registry: "{{ easydb_docker_registry }}"
    username: "{{ easydb_docker_user }}"
    password: "{{ easydb_docker_pass }}"
    reauthorize: yes

# Flush handlers now so the docker daemon doesn't restart immediatly after the instances have started.
- meta: flush_handlers

- name: creating easydb5 docker network
  docker_network:
    name: "{{ easydb_container_network }}"

- name: spinning up docker-containers
  with_items: "{{ easydb_host }}"
  loop_control:
    loop_var: easydb_container_name
  include_tasks: container.yml
